let stories = [
    [
        ["It was high summer.", "Một ngày hè oi ả."],
        ["A traveller hired a donkey and set out on a journey.", "Một người lữ hành thuê một con lừa và bắt đầu cuộc hành trình."],
        ["The owner of the donkey was following behind to drive the beast.", "Người chủ con lừa đi theo sau để dẫn nó đi."],
        ["At mid-day, they decided to take rest for some time but couldn't find any shady place around.", "Vào giữa trưa, họ quyết định nghỉ ngơi một lát nhưng không tìm thấy chỗ râm mát nào gần đó."],
        ["So, the traveler decided to rest in the shade of the donkey.", "Vì vậy, người lữ hành quyết định nghỉ dưới bóng râm của con lừa."],
        ["But the owner didn't let him do so as he himself wanted to sit in its shadow.", "Nhưng người chủ không cho phép vì chính anh ta cũng muốn ngồi trong bóng râm đó."],
        ["The traveller said, \"How can you refuse me the shadow? I have paid you money after all.\"", "Người lữ hành nói: \"Sao anh lại từ chối cho tôi bóng râm? Dù sao thì tôi cũng đã trả tiền cho anh rồi.\""],
        ["\"But you have paid for the ride, not for resting in his shadow\", retorted the owner.", "\"Nhưng anh trả tiền để đi nhờ, chứ không phải để nghỉ trong bóng của nó\", người chủ đáp trả."],
        ["So, an argument followed between the two.", "Thế là một cuộc tranh cãi nảy ra giữa hai người."],
        ["When the donkey saw that the owner and the hirer were busy fighting, he took to his heels and was soon out of sight.", "Khi con lừa thấy người chủ và người thuê đang mải mê cãi nhau, nó liền bỏ chạy và chẳng mấy chốc đã biến mất."]
    ],
    [
        ["Once a huge oak tree stood on the bank of a river.", "Ngày xửa ngày xưa, một cây sồi khổng lồ đứng bên bờ sông."],
        ["It was well nourished by the water of the river.", "Nó được nuôi dưỡng tốt bởi dòng nước sông."],
        ["Naturally, it was very strong and had a thick stem.", "Đương nhiên, nó rất khỏe mạnh và có thân cây to lớn."],
        ["Just nearby, grew some reeds with thin but flexible stems.", "Ngay gần đó, mọc lên những cây sậy với thân mỏng nhưng mềm dẻo."],
        ["They stood almost half in water and had flourished well too.", "Chúng mọc gần một nửa dưới nước và cũng phát triển rất tốt."],
        ["One day, strong winds blew.", "Một ngày nọ, gió lớn nổi lên."],
        ["The tree, though huge and strong, broke from the middle and was thrown across the stream just among the reeds.", "Cây sồi, dù to lớn và mạnh mẽ, đã bị gãy làm đôi và bị quăng xuống dòng suối, ngay giữa những đám sậy."],
        ["On the other hand, the tree was very surprised to see that the reeds suffered no harm at all.", "Mặt khác, cây sồi vô cùng ngạc nhiên khi thấy những cây sậy không hề bị tổn hại gì."],
        ["The oak could not make out the reason of the safety of the reeds and asked them, \"How is it that, you being frail and slender, managed to face the gale without any harm. But I, strong enough, have been broken.\"", "Cây sồi không thể hiểu được lý do vì sao những cây sậy lại an toàn và hỏi chúng: \"Làm sao các bạn, yếu đuối và mảnh khảnh như vậy, lại có thể đối mặt với cơn bão mà không hề hấn gì. Còn tôi, đủ mạnh mẽ, lại bị gãy đổ?\""],
        ["The reeds replied, \"You were proud of your strength and refused to bend. So, you broke while we bowed and yielded to the gale and were spared.\"", "Những cây sậy trả lời: \"Anh tự hào về sức mạnh của mình và từ chối cúi mình. Vì vậy, anh đã gãy trong khi chúng tôi cúi rạp và thuận theo cơn gió nên đã được an toàn.\""],
    ],
    [
        ["Once there lived a hind in a forest.", "Một thuở nọ có một con hươu mẹ ở một khu rừng."],
        ["She had a son who had grown very young and strong.", "Cô ấy có một đứa con trai đang tuổi lớn, rất khỏe mạnh."],
        ["She was very happy to see his stout body and branched strong horns and thought, \"stags have powerful horns, why should they be afraid of hounds, wolves then? It's sheer cowardice. I would never like my son to do it at all.\"", "Cô ấy rất vui khi thấy thân hình vạm vỡ và bộ sừng chắc khỏe nhiều nhánh của con và nghĩ: \"Hươu đực có bộ sừng mạnh mẽ, tại sao chúng lại phải sợ chó săn và chó sói nhỉ? Đó quả là sự hèn nhát. Tôi không bao giờ muốn con trai mình như vậy.\""],
        ["After some time, the hind's son came there.", "Một lúc sau, hươu con đến chỗ mẹ."],
        ["The hind wanted to teach him to be courageous.", "Hươu mẹ muốn dạy con mình trở nên dũng cảm."],
        ["She said, \"Son! You have a stout body and strong horns. So, you must not run away from hounds and wolves. Don't be a coward.\"", "Cô ấy nói: \"Con trai! Con có thân hình vạm vỡ và bộ sừng khỏe mạnh. Vì vậy, con không được bỏ chạy khỏi chó săn và chó sói. Đừng là một kẻ nhát gan.\""],
        ["\"Ok, mom; I won't\", said the stag.", "\"Vâng, mẹ; con sẽ không nhút nhát\", hươu con nói."],
        ["Just then the mother and the son heard the bark of the hounds.", "Vừa lúc đó, hai mẹ con nghe thấy tiếng sủa của chó săn."],
        ["The hind got ready to run away when her son asked her to stay on.", "Hươu mẹ vội vã chuẩn bị bỏ chạy thì hươu con bảo mẹ ở lại."],
        ["She said, \"You may, but I have no horns.\" Saying so, she ran as fast as she could.", "Cô ấy nói: \"Con có thể, nhưng mẹ không có sừng.\" Nói xong, cô ấy chạy nhanh hết sức có thể."],
        ["The mother herself was a coward and was teaching courage to her son. What a satire!", "Bản thân người mẹ là một kẻ nhát gan lại đi dạy con sự dũng cảm. Thật là một sự mỉa mai!"]
    ]
];

let currentStoryIndex = 0;
let currentSentence = 0;
let speed = 1.0;
let volume = 1.0;
let noiseLevel = 0.3;
let isPlaying = false;
let isNoiseEnabled = false;
let synth = window.speechSynthesis;
let utterance = null;
let voices = [];
let selectedVoice = null;
let currentEffect = 'normal';

const noiseFiles = {
    'coffee_shop': './src/coffee-shop-noise.mp3',
    'traffic': './src/traffic-noise.mp3',
    'ambient': './src/ambient-noise.mp3',
    'office': './src/office-noise.mp3',
    'white-noise': './src/white-noise.mp3'
};
let currentNoise = 'coffee_shop';
let noiseSound = new Howl({
    src: [noiseFiles[currentNoise]],
    loop: true,
    volume: volume * noiseLevel
});

function loadVoices() {
    voices = synth.getVoices().filter(voice => voice.lang.startsWith('en'));
    const voiceSelect = document.getElementById('voiceSelect');
    voiceSelect.innerHTML = '';
    voices.forEach((voice, index) => {
        const option = document.createElement('option');
        option.value = index;
        option.text = voice.name + ' (' + voice.lang + ')';
        voiceSelect.appendChild(option);
    });
    if (voices.length > 0) {
        selectedVoice = voices[0];
    } else {
        console.warn('No English voices available.');
    }
}

synth.onvoiceschanged = loadVoices;
loadVoices();

function changeVoice() {
    const voiceSelect = document.getElementById('voiceSelect');
    selectedVoice = voices[voiceSelect.value];
    if (isPlaying) {
        synth.cancel();
        speakSentence();
    }
}

function changeSpeed(value) {
    speed = parseFloat(value);
    document.getElementById('speedValue').textContent = `${speed.toFixed(1)}x`;
    if (isPlaying) {
        synth.cancel();
        speakSentence();
    }
}

function changeVolume(value) {
    volume = parseFloat(value);
    document.getElementById('volumeValue').textContent = `${Math.round(volume * 100)}%`;
    noiseSound.volume(volume * noiseLevel);
    if (isPlaying) {
        synth.cancel();
        speakSentence();
    }
}

function changeNoiseLevel(value) {
    noiseLevel = parseFloat(value);
    document.getElementById('noiseLevelValue').textContent = `${Math.round(noiseLevel * 100)}%`;
    if (isNoiseEnabled && isPlaying) {
        noiseSound.volume(volume * noiseLevel);
    }
}

function changeEffect() {
    currentEffect = document.getElementById('effectSelect').value;
    if (isPlaying) {
        synth.cancel();
        speakSentence();
    }
}

function updateText() {
    let storyBox = document.getElementById("storyBox");
    storyBox.innerHTML = "";
    for (let i = 0; i < stories[currentStoryIndex].length; i++) {
        let englishText = stories[currentStoryIndex][i][0];
        let vietnameseText = stories[currentStoryIndex][i][1];
        let newText = document.createElement("div");
        newText.classList.add("sentence");
        if (i === currentSentence) {
            newText.classList.add("highlight");
        }
        newText.innerHTML = englishText;
        newText.addEventListener('click', () => selectSentence(i));
        storyBox.appendChild(newText);
        let translationText = document.createElement("div");
        translationText.classList.add("translation");
        if (!document.getElementById('showTranslation').checked) {
            translationText.classList.add('hidden');
        }
        translationText.innerText = vietnameseText;
        storyBox.appendChild(translationText);
    }
    if (currentSentence < stories[currentStoryIndex].length) {
        let highlightedElement = storyBox.querySelector('.highlight');
        if (highlightedElement) {
            let elementTop = highlightedElement.offsetTop;
            let elementHeight = highlightedElement.offsetHeight;
            let boxHeight = storyBox.clientHeight;
            let scrollPosition = elementTop - (boxHeight) + (elementHeight/2);
            storyBox.scrollTop = scrollPosition;
        }
    }
    updateProgress();
}

function selectSentence(index) {
    currentSentence = index;
    if (isPlaying) {
        synth.cancel();
        speakSentence();
    } else {
        updateText();
    }
}

function updateProgress() {
    let progressBar = document.getElementById("progressBar");
    let progress = (currentSentence / stories[currentStoryIndex].length) * 100;
    progressBar.style.width = `${progress}%`;
}

function playStory() {
    if (isPlaying) return;
    isPlaying = true;
    currentSentence = 0;
    document.getElementById("storyBox").innerHTML = "";
    speakSentence();
}

function speakSentence() {
    if (currentSentence >= stories[currentStoryIndex].length) {
        isPlaying = false;
        stopNoise();
        showEndModal();
        return;
    }
    let sentence = stories[currentStoryIndex][currentSentence][0];
    utterance = new SpeechSynthesisUtterance(sentence);
    utterance.volume = volume;
    if (selectedVoice) {
        utterance.voice = selectedVoice;
    }
    switch (currentEffect) {
        case 'robot':
            utterance.pitch = 0.5;
            utterance.rate = 0.8;
            break;
        case 'highpitch':
            utterance.pitch = 1.5;
            utterance.rate = speed;
            break;
        case 'lowpitch':
            utterance.pitch = 0.5;
            utterance.rate = speed;
            break;
        default:
            utterance.pitch = 1.0;
            utterance.rate = speed;
            break;
    }
    utterance.onend = () => {
        if (isPlaying) {
            currentSentence++;
            if (currentSentence < stories[currentStoryIndex].length) {
                speakSentence();
            } else {
                isPlaying = false;
                stopNoise();
                showEndModal();
            }
        }
    };
    try {
        synth.speak(utterance);
        if (isNoiseEnabled) startNoise();
        updateText();
    } catch (error) {
        console.error("Error playing speech:", error);
        isPlaying = false;
        stopNoise();
    }
}

function startNoise() {
    try {
        noiseSound.volume(volume * noiseLevel);
        noiseSound.play();
    } catch (error) {
        console.error("Error playing noise:", error);
    }
}

function stopNoise() {
    try {
        noiseSound.stop();
    } catch (error) {
        console.error("Error stopping noise:", error);
    }
}

function toggleNoise() {
    isNoiseEnabled = !isNoiseEnabled;
    if (isNoiseEnabled && isPlaying) {
        startNoise();
    } else {
        stopNoise();
    }
    document.querySelector(".noise-toggle").innerText = isNoiseEnabled ? "Disable Noise" : "Enable Noise";
}

function changeNoise() {
    currentNoise = document.getElementById('noiseSelect').value;
    noiseSound.unload();
    noiseSound = new Howl({
        src: [noiseFiles[currentNoise]],
        loop: true,
        volume: volume * noiseLevel
    });
    if (isNoiseEnabled && isPlaying) startNoise();
}

function pauseStory() {
    if (utterance) {
        synth.cancel();
        stopNoise();
        isPlaying = false;
    }
}

function resetStory() {
    pauseStory();
    currentSentence = 0;
    document.getElementById("storyBox").innerHTML = "";
    updateProgress();
}

function changeStory() {
    currentStoryIndex = document.getElementById("storySelect").value;
    resetStory();
}

function toggleTranslation() {
    let showTranslation = document.getElementById('showTranslation').checked;
    let translations = document.querySelectorAll('.translation');
    translations.forEach(translation => {
        if (showTranslation) {
            translation.classList.remove('hidden');
        } else {
            translation.classList.add('hidden');
        }
    });
}

function showEndModal() {
    let modal = document.getElementById('endModal');
    let modalMessage = document.getElementById('modalMessage');
    let nextStoryBtn = document.getElementById('nextStoryBtn');
    if (currentStoryIndex < stories.length - 1) {
        modalMessage.textContent = "Bạn muốn làm gì tiếp theo?";
        nextStoryBtn.style.display = 'inline-block';
    } else {
        modalMessage.textContent = "Đây là bài cuối cùng.";
        nextStoryBtn.style.display = 'none';
    }
    modal.style.display = 'block';
}

function closeModal() {
    document.getElementById('endModal').style.display = 'none';
}

function replayStory() {
    closeModal();
    currentSentence = 0;
    document.getElementById("storyBox").innerHTML = "";
    isPlaying = true;
    speakSentence();
}

function nextStory() {
    closeModal();
    if (currentStoryIndex < stories.length - 1) {
        currentStoryIndex++;
        document.getElementById("storySelect").value = currentStoryIndex;
        resetStory();
        isPlaying = true;
        speakSentence();
    }
}

if (!window.speechSynthesis) {
    console.error("SpeechSynthesis is not supported in this browser.");
    alert("This browser does not support text-to-speech. Please use Chrome or Edge.");
}